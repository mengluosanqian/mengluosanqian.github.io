<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/09/JavaScript/this%E6%8C%87%E5%90%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/09/JavaScript/this%E6%8C%87%E5%90%91/" class="post-title-link" itemprop="url">this指向</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-09 14:12:58" itemprop="dateCreated datePublished" datetime="2022-06-09T14:12:58+08:00">2022-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-16 10:08:10" itemprop="dateModified" datetime="2022-06-16T10:08:10+08:00">2022-06-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="this指向"><a href="#this指向" class="headerlink" title="this指向"></a>this指向</h1><ol>
<li>绑定优先级：new绑定 &gt; 显式绑定 &gt; 隐式绑定 &gt; 默认绑定</li>
</ol>
<h2 id="默认绑定"><a href="#默认绑定" class="headerlink" title="默认绑定"></a>默认绑定</h2><p>非严格模式下，this指向全局对象，严格模式下this会绑定为undefined</p>
<h2 id="隐式绑定"><a href="#隐式绑定" class="headerlink" title="隐式绑定"></a>隐式绑定</h2><ol>
<li>满足XXX.fn()格式。fn的this指向XXX。</li>
<li>如果存在链式调用，this永远指向最后调用它的那个对象  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">x</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">fun</span>:<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> x = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fun = obj.<span class="property">fun</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">fun</span>(), <span class="title function_">fun</span>());</span><br><span class="line"><span class="comment">// obj.fun()中的this指向调用者obj，而给obj.fun起别名后，隐式绑定丢失，指向window</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="隐式绑定丢失"><a href="#隐式绑定丢失" class="headerlink" title="隐式绑定丢失"></a>隐式绑定丢失</h2><ol>
<li>起函数别名，通过别名运行</li>
<li>函数作为参数会造成隐式绑定丢失  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">getAge</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">age</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> getAge = person.<span class="property">getAge</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getAge</span>())</span><br><span class="line"><span class="comment">// 隐式绑定丢失,返回undefined</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="显示绑定"><a href="#显示绑定" class="headerlink" title="显示绑定"></a>显示绑定</h2><ol>
<li>通过call&#x2F;apply&#x2F;bind修改this指向  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fun</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> f = fun.<span class="title function_">call</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;foo&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">var</span> t1 = f.<span class="title function_">call</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;bar&#x27;</span>&#125;)()()</span><br><span class="line"><span class="keyword">var</span> t2 = <span class="title function_">f</span>().<span class="title function_">call</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;baz&#x27;</span>&#125;)()</span><br><span class="line"><span class="keyword">var</span> t3 = <span class="title function_">f</span>()().<span class="title function_">call</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;qux&#x27;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="new绑定"><a href="#new绑定" class="headerlink" title="new绑定"></a>new绑定</h2><ol>
<li>通过new来调用构造函数，会生成一个新对象，并把这个新对象绑定为调用函数的this<ul>
<li>创建一个空的简单JavaScript对象，即（{}）</li>
<li>为上一步新创建的对象添加属性__proto__</li>
<li>将第一步新创建的对象作为this的上下文</li>
<li>如果该函数没有返回对象，则返回this  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123; </span><br><span class="line">    a = <span class="number">0</span>; </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>); </span><br><span class="line">    <span class="keyword">var</span> a;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title function_">test</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h2 id="箭头函数绑定"><a href="#箭头函数绑定" class="headerlink" title="箭头函数绑定"></a>箭头函数绑定</h2><ol>
<li>箭头函数没有this，它的this是通过作用域链查到外层作用域的this，且指向函数定义时的this而非执行时的</li>
<li>不能通过call、apply、bind来修改this指向，但可以通过修改外层作用域的this来达成间接修改</li>
<li>JavaScript是静态作用域，即函数的作用域在函数定义的时候就决定了，而箭头函数的this 是通过作用域链查到的，因此箭头函数定义后，它的作用域链就定死了<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj1 = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">foo</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// log1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj1.<span class="title function_">foo</span>())</span><br><span class="line"><span class="keyword">const</span> obj2 = obj1.<span class="property">foo</span></span><br><span class="line"><span class="comment">// log2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">obj2</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// obj1.foo 为箭头函数，obj1 为对象，无法提供外层作用域，因此 obj.foo 里面的 this 指向 window</span></span><br><span class="line"><span class="comment">// obj1.foo(): 箭头函数，this 指向 window，打印 undefined</span></span><br><span class="line"><span class="comment">// obj2 隐式绑定丢失: 打印 undefined</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;local&#x27;</span>,</span><br><span class="line">    <span class="attr">foo</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;.<span class="title function_">bind</span>(<span class="variable language_">window</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="keyword">new</span> obj.<span class="title function_">foo</span>();</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">name</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="property">name</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> bar3 = bar2 = bar;</span><br><span class="line">bar2.<span class="property">name</span> = <span class="string">&#x27;foo2&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar3.<span class="property">name</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>obj.foo 将它的 this 通过 bind 显式的绑定为 window，但 bind 不会立即执行</li>
<li>var bar &#x3D; new obj.foo(): new 绑定优先级大于 bind ，因此 bind 失效了，此时 this 指向 new 实例，因此 obj.foo 内部的 console 打印 foo</li>
<li>bar 是 new obj.foo() 的实例，console.log(bar.name) 打印 foo</li>
<li>bar3 &#x3D; bar2 &#x3D; bar，将 bar2，bar3，bar 的地址都指向 bar 所指向的空间。</li>
<li>bar2.name &#x3D; ‘foo2’，修改地址指向堆内存的值</li>
<li>console.log(bar3.name): 由于三个变量指向同一块地址，bar3 修改了 name ，bar3 也随之改变，打印 foo2</li>
<li>setTimeout 的回调执行，打印 global</li>
</ol>
<h2 id="去除new绑定"><a href="#去除new绑定" class="headerlink" title="去除new绑定"></a>去除new绑定</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;local&#x27;</span>,</span><br><span class="line">    <span class="attr">foo</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;.<span class="title function_">bind</span>(<span class="variable language_">window</span>)</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="title function_">foo</span>();</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line"><span class="comment">// obj.foo 没有做修改，它的 this 通过 bind 显式的绑定为 window，但 bind 不会立即执行</span></span><br><span class="line"><span class="comment">// obj.foo的this通过bind修改为window</span></span><br><span class="line"><span class="comment">// obj.foo()执行，显示绑定优先级大于隐式绑定，因此此时foo函数的this变为了window</span></span><br><span class="line"><span class="comment">// this.name相对于window.name，修改了全局的name属性</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/04/%E5%B7%A5%E7%A8%8B%E5%8C%96/qiankun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/04/%E5%B7%A5%E7%A8%8B%E5%8C%96/qiankun/" class="post-title-link" itemprop="url">qiankun</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-04 22:51:27" itemprop="dateCreated datePublished" datetime="2022-06-04T22:51:27+08:00">2022-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-05 18:10:28" itemprop="dateModified" datetime="2022-06-05T18:10:28+08:00">2022-06-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/qiankun/" itemprop="url" rel="index"><span itemprop="name">qiankun</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="主服务"><a href="#主服务" class="headerlink" title="主服务"></a>主服务</h2><ol>
<li>在主服务中注册微应用</li>
<li><code>registerMicroApps</code>接收两个参数<ul>
<li>apps：必选，微应用的一些注册信息<ul>
<li>name: 微应用名称，必选</li>
<li>entry：必选，微应用的入口</li>
<li>container：必选，微应用的容器节点的选择器或者 Element 实例</li>
<li>activeRule：必选，微应用的激活规则</li>
</ul>
</li>
<li>lifeCycles：可选，全局的微应用生命周期钩子</li>
</ul>
</li>
</ol>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, setDefaultMountApp, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span> <span class="comment">// 引入qiankun服务</span></span><br><span class="line"><span class="comment">// 基于路由配置</span></span><br><span class="line"><span class="title function_">registerMicroApps</span>(microApps, &#123;</span><br><span class="line">  <span class="attr">beforeLoad</span>: [</span><br><span class="line">    <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;before load&#x27;</span>, app)</span><br><span class="line">    &#125;</span><br><span class="line">  ], <span class="comment">// 挂载前回调</span></span><br><span class="line">  <span class="attr">beforeMount</span>: [</span><br><span class="line">    <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;before mount&#x27;</span>, app)</span><br><span class="line">    &#125;</span><br><span class="line">  ], <span class="comment">// 挂载后回调</span></span><br><span class="line">  <span class="attr">afterUnmount</span>: [</span><br><span class="line">    <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;after unload&#x27;</span>, app)</span><br><span class="line">    &#125;</span><br><span class="line">  ] <span class="comment">// 卸载后回调</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>注册子应用<ul>
<li>这里的子应用就是<code>registerMicroApps</code>第一个属性  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 注册子应用</span></span><br><span class="line"><span class="keyword">const</span> hostname = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hostname</span>;</span><br><span class="line"><span class="keyword">const</span> microApps = config.<span class="property">subAPP</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name, port, activeRule,host &#125; = item</span><br><span class="line">  <span class="keyword">const</span> origin = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">origin</span>;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">pkcSubAPPConfig</span>[item.<span class="property">name</span>] = &#123;...item,<span class="attr">entry</span>:<span class="string">`http://<span class="subst">$&#123;host||hostname&#125;</span>:<span class="subst">$&#123;port&#125;</span>/`</span>&#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    name,</span><br><span class="line">    <span class="comment">//entry:`http://$&#123;host||hostname&#125;:$&#123;port&#125;`,</span></span><br><span class="line">    <span class="attr">entry</span>:(hostname == <span class="string">&#x27;localhost&#x27;</span>||hostname == <span class="string">&#x27;127.0.0.1&#x27;</span>)?<span class="string">`http://<span class="subst">$&#123;host||hostname&#125;</span>:<span class="subst">$&#123;port&#125;</span>/`</span>:<span class="string">`<span class="subst">$&#123;origin&#125;</span>/<span class="subst">$&#123;item.name&#125;</span>/`</span>,</span><br><span class="line">    render,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="title function_">genActiveRule</span>(activeRule),</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">activeApp</span>:item</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h2 id="微应用配置"><a href="#微应用配置" class="headerlink" title="微应用配置"></a>微应用配置</h2><ol>
<li>导出相应的生命周期钩子<ul>
<li>微应用需要在自己的入口 js (通常就是你配置的 webpack 的 entry js) 导出 bootstrap、mount、unmount 三个生命周期钩子，以供主应用在适当的时机调用。</li>
</ul>
</li>
</ol>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = props.<span class="property">activeApp</span>.<span class="property">activeRule</span>; </span><br><span class="line">    <span class="title function_">render</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    instance.$destroy();</span><br><span class="line">    instance = <span class="literal">null</span>;</span><br><span class="line">    router = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置微应用的打包工具<ul>
<li>除了代码中暴露出相应的生命周期钩子之外，为了让主应用能正确识别微应用暴露出来的一些信息，微应用的打包工具需要增加如下配置：</li>
</ul>
</li>
</ol>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> packageName = <span class="built_in">require</span>(<span class="string">&#x27;./package.json&#x27;</span>).<span class="property">name</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">library</span>: <span class="string">`<span class="subst">$&#123;packageName&#125;</span>-[name]`</span>,</span><br><span class="line">    <span class="attr">libraryTarget</span>: <span class="string">&#x27;umd&#x27;</span>,</span><br><span class="line">    <span class="attr">jsonpFunction</span>: <span class="string">`webpackJsonp_<span class="subst">$&#123;packageName&#125;</span>`</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="其他实际用到的API"><a href="#其他实际用到的API" class="headerlink" title="其他实际用到的API"></a>其他实际用到的API</h2><h3 id="setDefaultMountApp-appLink"><a href="#setDefaultMountApp-appLink" class="headerlink" title="setDefaultMountApp(appLink)"></a>setDefaultMountApp(appLink)</h3><ol>
<li>设置主应用启动后默认进入的微应用<ul>
<li>实际项目中根据终端和用户角色判断启动后默认打开哪个微服务</li>
</ul>
</li>
</ol>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setDefaultMountApp &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="comment">// 设置默认子应用,与 genActiveRule中的参数保持一致</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getQueryString</span> = (<span class="params">name</span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;(^|&amp;)&#x27;</span> + name + <span class="string">&#x27;=([^&amp;]*)(&amp;|$)&#x27;</span>, <span class="string">&#x27;i&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> r = location.<span class="property">search</span>.<span class="title function_">substr</span>(<span class="number">1</span>).<span class="title function_">match</span>(reg);</span><br><span class="line">  <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> token = <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (token&amp;&amp;token!==<span class="string">&#x27;null&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> roleName = <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;roleName&#x27;</span>)</span><br><span class="line">  <span class="keyword">switch</span> (roleName) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;adminEnd&#x27;</span>:</span><br><span class="line">      <span class="title function_">setDefaultMountApp</span>(<span class="string">&#x27;/portal&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;devEnd&#x27;</span>:</span><br><span class="line">      <span class="title function_">setDefaultMountApp</span>(<span class="string">&#x27;/dev&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;userEnd&#x27;</span>:</span><br><span class="line">      <span class="title function_">setDefaultMountApp</span>(<span class="string">&#x27;/portal&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="title function_">getQueryString</span>(<span class="string">&#x27;token&#x27;</span>)||<span class="title function_">getQueryString</span>(<span class="string">&#x27;thirdSign&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span>(token)&#123;</span><br><span class="line">    <span class="keyword">let</span> temp = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> config.<span class="property">subAPP</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; activeRule &#125; = item</span><br><span class="line">      <span class="keyword">if</span> (location.<span class="property">pathname</span>.<span class="title function_">startsWith</span>(activeRule)) &#123;</span><br><span class="line">        <span class="title function_">setDefaultMountApp</span>(activeRule)</span><br><span class="line">        temp = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!temp) &#123;</span><br><span class="line">      <span class="title function_">setDefaultMountApp</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> temp = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> config.<span class="property">subAPP</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; activeRule, auth &#125; = item</span><br><span class="line">      <span class="keyword">if</span> (!auth &amp;&amp; location.<span class="property">pathname</span>.<span class="title function_">startsWith</span>(activeRule)) &#123;</span><br><span class="line">        <span class="title function_">setDefaultMountApp</span>(activeRule)</span><br><span class="line">        temp = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!temp) &#123;</span><br><span class="line">      <span class="title function_">setDefaultMountApp</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">prefetch</span>: <span class="literal">false</span>, <span class="comment">// 可选，是否开启预加载</span></span><br><span class="line">  <span class="attr">singular</span>: <span class="literal">true</span>, <span class="comment">// 可选，是否为单实例场景，单实例指的是同一时间只会渲染一个微应用。默认为 true。</span></span><br><span class="line">  <span class="attr">sandbox</span>:<span class="literal">false</span>, <span class="comment">// 可选，是否开启沙箱，默认为 true。默认情况下沙箱可以确保单实例场景子应用之间的样式隔离，但是无法确保主应用跟子应用、或者多实例场景的子应用样式隔离。</span></span><br><span class="line">  <span class="attr">fetch</span>: <span class="variable language_">window</span>.<span class="property">fetch</span>, <span class="comment">// 可选，自定义的 fetch 方法</span></span><br><span class="line">  <span class="attr">getPublicPath</span>:<span class="function">(<span class="params">entry</span>) =&gt;</span> entry, <span class="comment">// 可选，参数是微应用的 entry 值</span></span><br><span class="line">  <span class="attr">excludeAssetFilter</span>: <span class="function"><span class="params">assetUrl</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> whiteList = []</span><br><span class="line">    <span class="keyword">const</span> whiteWords = [<span class="string">&#x27;http://127.0.0.1:9889/register&#x27;</span>,<span class="string">&#x27;http://127.0.0.1:9889/verify&#x27;</span>,<span class="string">&#x27;http://127.0.0.1:9889/get&#x27;</span>,<span class="string">&#x27;http://127.0.0.1:9889/voice&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (whiteList.<span class="title function_">includes</span>(assetUrl)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> whiteWords.<span class="title function_">some</span>(<span class="function"><span class="params">w</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> assetUrl.<span class="title function_">includes</span>(w)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;) <span class="comment">// 可选，指定部分特殊的动态加载的微应用资源（css/js) 不被 qiankun 劫持处理。</span></span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>qiankun测试项目<br><a target="_blank" rel="noopener" href="https://github.com/mengluosanqian/qiankun-learning.git">https://github.com/mengluosanqian/qiankun-learning.git</a></li>
<li>官网<br><a target="_blank" rel="noopener" href="https://qiankun.umijs.org/zh">https://qiankun.umijs.org/zh</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/03/%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/03/%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">项目中的性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-03 16:10:25" itemprop="dateCreated datePublished" datetime="2022-06-03T16:10:25+08:00">2022-06-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-18 16:29:52" itemprop="dateModified" datetime="2023-06-18T16:29:52+08:00">2023-06-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="利用webpack-bundle-analyzer分析"><a href="#利用webpack-bundle-analyzer分析" class="headerlink" title="利用webpack-bundle-analyzer分析"></a>利用webpack-bundle-analyzer分析</h1><ol>
<li>安装webpack-bundle-analyzer插件，利用插件分析</li>
</ol>
<h2 id="video"><a href="#video" class="headerlink" title="video"></a>video</h2><ol>
<li>项目中video.js占用过大，有900kb以上</li>
<li>换用vue-video-player.js</li>
<li>将video,min.js 和 vue-video-player.js 单独拿出来放在static目录下，在 index.html中引入<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="title class_">Include</span> the videojs library --&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./static/video.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;!-- videojs <span class="variable constant_">JS</span> <span class="title class_">Vue</span> --&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./static/vue-video-player.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="element-ui"><a href="#element-ui" class="headerlink" title="element-ui"></a>element-ui</h2><ol>
<li>项目中其实有很多组件用不到，只有在实际用户端会用到所有组件</li>
<li>后期开发中，想要采用微服务的架构，把页面、模型、方法以及BI、大屏等代码进行拆分</li>
<li>另外细分，可以把登录、移动端、pc端等拆分开来</li>
<li>element按需引入</li>
</ol>
<h2 id="loadash"><a href="#loadash" class="headerlink" title="loadash"></a>loadash</h2><ol>
<li>整个项目中只用到了里面的防抖和深拷贝</li>
<li>自己实现防抖和深拷贝，不再全局引入</li>
</ol>
<h1 id="图片换成iconfont"><a href="#图片换成iconfont" class="headerlink" title="图片换成iconfont"></a>图片换成iconfont</h1><h1 id="编写高性能js"><a href="#编写高性能js" class="headerlink" title="编写高性能js"></a>编写高性能js</h1><ol>
<li>遵循严格模式：’use strict’</li>
<li>将js脚本放在页面底部，加快渲染页面</li>
<li>将js脚本成组打包，减少请求</li>
<li>使用非阻塞方式下载js脚本</li>
<li>尽量使用局部变量来保存全局变量</li>
<li>尽量减少使用闭包</li>
<li>使用window对象属性方法时，省略window</li>
<li>尽量减少对象成员嵌套</li>
<li>缓存DOM节点的访问</li>
<li>避免使用eval()和Function()构造器</li>
<li>给setTimeout和setInterval传递函数而不是字符串作为参数</li>
<li>尽量使用直接量创建对象和数组</li>
<li>最小化重绘和回流</li>
</ol>
<h1 id="css的优化"><a href="#css的优化" class="headerlink" title="css的优化"></a>css的优化</h1><h2 id="加载性能优化"><a href="#加载性能优化" class="headerlink" title="加载性能优化"></a>加载性能优化</h2><ol>
<li>css压缩<ul>
<li>将写好的css进行打包压缩，可以减小文件体积</li>
</ul>
</li>
<li>css单一样式<ul>
<li>当需要下边距和左边距的时候，很多时候会选择使用 margin:top 0 bottom 0；但margin-bottom:bottom;margin-left:left;执行效率会更高。</li>
</ul>
</li>
<li>减少使用@import，建议使用link，因为后者在页面加载时一起加载，前者是等待页面加载完成之后再进行加载</li>
</ol>
<h2 id="选择器性能"><a href="#选择器性能" class="headerlink" title="选择器性能"></a>选择器性能</h2><ol>
<li>关键选择器<ul>
<li>选择器的最后面的部分为关键选择器（即用来匹配目标元素的部分）。CSS选择符是从右到左进行匹配的。当使用后代选择器的时候，浏览器会遍历所有子元素来确定是否是指定的元素等等；</li>
</ul>
</li>
<li>如果规则拥有ID选择器作为其关键选择器，则不要为规则增加标签。过滤掉无关的规则</li>
<li>避免使用通配规则</li>
<li>尽量少的对标签进行选择，而是用class</li>
<li>尽量少的去使用后代选择器，降低选择器的权重值。后代选择器的开销是最高的，尽量将选择器的深度降到最低，最高不要超过三层，更多的使用类来关联每一个标签元素。</li>
<li>了解哪些属性是可以通过继承而来的，然后避免对这些属性重复指定规则。</li>
</ol>
<h2 id="渲染性能"><a href="#渲染性能" class="headerlink" title="渲染性能"></a>渲染性能</h2><ol>
<li>慎重使用高性能属性：浮动、定位</li>
<li>尽量减少页面重排、重绘</li>
<li>去空规则</li>
<li>属性值为0，不加单位</li>
<li>选择器优化嵌套，尽量避免层级过深</li>
<li>不使用@import前缀，它会影响css的加载速度</li>
<li>属性值为浮动小数0.**，可以省略小数点之前的0。</li>
<li>不滥用web字体。对于中文网站来说WebFonts可能很陌生，国外却很流行。web fonts通常体积庞大，而且一些浏览器在下载web fonts时会阻塞页面渲染损伤性能</li>
</ol>
<h2 id="可维护性、健壮性"><a href="#可维护性、健壮性" class="headerlink" title="可维护性、健壮性"></a>可维护性、健壮性</h2><ol>
<li>将具有相同逻辑的样式抽离出来，整合并通过class在页面中进行使用，提高css的可维护性</li>
<li>样式与内容分离，将css代码定义到外部css中</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/03/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%AE%9E%E7%8E%B0babel%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/03/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%AE%9E%E7%8E%B0babel%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">实现babel插件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-03 10:27:16 / Modified: 10:46:30" itemprop="dateCreated datePublished" datetime="2022-06-03T10:27:16+08:00">2022-06-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="实现babel"><a href="#实现babel" class="headerlink" title="实现babel"></a>实现babel</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">&#123;types: t&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">visitor</span>: &#123;</span><br><span class="line">      <span class="title class_">Identifier</span> (path) &#123; <span class="comment">// 标识符,path包含了很多节点信息和方法</span></span><br><span class="line">        <span class="comment">//   console.log(&#x27;Identifier&#x27;, path.node.name);</span></span><br><span class="line">        <span class="keyword">const</span> parentIsIf = t.<span class="title function_">isIfStatement</span>(path.<span class="property">parentPath</span>)</span><br><span class="line">        <span class="keyword">const</span> isDebug = path.<span class="property">node</span>.<span class="property">name</span> === <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">        <span class="comment">// console.log(parentIsIf, isDebug)</span></span><br><span class="line">        <span class="keyword">if</span> (isDebug &amp;&amp; parentIsIf) &#123;</span><br><span class="line">          <span class="comment">// 把Identifier转换成string</span></span><br><span class="line">          <span class="keyword">const</span> stringNode = t.<span class="title function_">stringLiteral</span>(<span class="string">&#x27;DEBUG&#x27;</span>)</span><br><span class="line">          path.<span class="title function_">replaceWith</span>(stringNode)</span><br><span class="line">          <span class="comment">// 原来</span></span><br><span class="line">          <span class="comment">//   IfStatement &#123;</span></span><br><span class="line">          <span class="comment">//       test: this.Identifier &#123;</span></span><br><span class="line">          <span class="comment">//           name: &#x27;DEBUG&#x27;</span></span><br><span class="line">          <span class="comment">//       &#125;</span></span><br><span class="line">          <span class="comment">//   &#125;</span></span><br><span class="line">          <span class="comment">// 转换后</span></span><br><span class="line">          <span class="comment">// IfStatement &#123;</span></span><br><span class="line">          <span class="comment">//     test: StringLiteral&#123;</span></span><br><span class="line">          <span class="comment">//         extra: &#123;</span></span><br><span class="line">          <span class="comment">//             rawValue: &#x27;DEBUG&#x27;</span></span><br><span class="line">          <span class="comment">//             raw: &#x27;DEBUG&#x27;</span></span><br><span class="line">          <span class="comment">//         &#125;</span></span><br><span class="line">          <span class="comment">//         value: &#x27;DEBUG&#x27;</span></span><br><span class="line">          <span class="comment">//     &#125;</span></span><br><span class="line">          <span class="comment">// &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title class_">StringLiteral</span> (path, state) &#123;</span><br><span class="line">        <span class="keyword">const</span> parentIsIf = t.<span class="title function_">isIfStatement</span>(path.<span class="property">parentPath</span>)</span><br><span class="line">        <span class="keyword">const</span> isDebug = path.<span class="property">node</span>.<span class="property">value</span> === <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> (isDebug &amp;&amp; parentIsIf) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 生产环境下才移除</span></span><br><span class="line">            path.<span class="property">parentPath</span>.<span class="title function_">remove</span>()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/01/%E5%B7%A5%E7%A8%8B%E5%8C%96/mini-webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/01/%E5%B7%A5%E7%A8%8B%E5%8C%96/mini-webpack/" class="post-title-link" itemprop="url">mini-webpack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-01 10:20:17 / Modified: 11:42:57" itemprop="dateCreated datePublished" datetime="2022-06-01T10:20:17+08:00">2022-06-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mini-webpack"><a href="#mini-webpack" class="headerlink" title="mini-webpack"></a>mini-webpack</h1><h2 id="处理文件"><a href="#处理文件" class="headerlink" title="处理文件"></a>处理文件</h2><ol>
<li>对于webpack来说，首先要做的是处理文件信息，获取文件的内容<ul>
<li>利用<code>fs.readFileSync</code>读取文件</li>
</ul>
</li>
<li>根据获取到的文件来获取文件的依赖关系<ul>
<li>利用babel&#x2F;parser将获取的文件转化为AST,并指定<code>sourceType: &#39;module&#39;</code>使文件可以解析import导入的文件</li>
<li>利用babel&#x2F;traverse实现对AST的查找，找到其中的<code>node.source.value</code>，即当前文件引用了哪个文件，则认为存在依赖关系</li>
</ul>
</li>
<li>创建一个deps容器用于收集依赖关系<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createAsset</span>(<span class="params">filePath</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获取文件的内容</span></span><br><span class="line">    <span class="keyword">let</span> source = fs.<span class="title function_">readFileSync</span>(filePath, &#123;</span><br><span class="line">        <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// console.log(source);</span></span><br><span class="line">    <span class="comment">// 2. 获取依赖关系</span></span><br><span class="line">    <span class="comment">// 通过babel/parser把文件内容转化成AST</span></span><br><span class="line">    <span class="keyword">const</span> ast = parser.<span class="title function_">parse</span>(source, &#123;</span><br><span class="line">        <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// console.log(ast);</span></span><br><span class="line">    <span class="keyword">const</span> deps = [] <span class="comment">// 用于暂存依赖关系</span></span><br><span class="line">    <span class="comment">// 通过babel/parser把文件</span></span><br><span class="line">    traverse.<span class="title function_">default</span>(ast, &#123;</span><br><span class="line">        <span class="title class_">ImportDeclaration</span>(&#123;</span><br><span class="line">            node</span><br><span class="line">        &#125;) &#123;</span><br><span class="line">            <span class="comment">// console.log(node);</span></span><br><span class="line">            <span class="comment">// 要使用的是里面的source里面的value</span></span><br><span class="line">            <span class="comment">// console.log(node.source.value);</span></span><br><span class="line">            deps.<span class="title function_">push</span>(node.<span class="property">source</span>.<span class="property">value</span>) <span class="comment">// 存储依赖关系，比如有foo.js，说明source文件依赖于foo.js</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        code</span><br><span class="line">    &#125; = <span class="title function_">transformFromAst</span>(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">        <span class="attr">presets</span>: [<span class="string">&#x27;env&#x27;</span>],</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// console.log(code);</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        filePath,</span><br><span class="line">        code,</span><br><span class="line">        deps,</span><br><span class="line">        <span class="attr">mapping</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">id</span>: id++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="根据依赖关系生成图结构"><a href="#根据依赖关系生成图结构" class="headerlink" title="根据依赖关系生成图结构"></a>根据依赖关系生成图结构</h2><ol>
<li>由于文件可能有相互引用的关系，所以文件之间不是简单的树结构，而是图结构</li>
<li>指定解析的入口文件，一般来说是main.js文件</li>
<li>将main.js作为入口文件放入一个栈中，遍历栈中元素，再遍历每一个元素的deps属性（即依赖关系），将每一个属性添加上相对路径后添加到栈中，直到栈为空</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createGraph</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mainAsset = <span class="title function_">createAsset</span>(<span class="string">&#x27;./example/main.js&#x27;</span>) <span class="comment">// 入口</span></span><br><span class="line">    <span class="keyword">const</span> queue = [mainAsset]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> queue) &#123;</span><br><span class="line">        asset.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">relativePath</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> child = <span class="title function_">createAsset</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./example&#x27;</span>, relativePath))</span><br><span class="line">            asset.<span class="property">mapping</span>[relativePath] = child.<span class="property">id</span></span><br><span class="line">            queue.<span class="title function_">push</span>(child)</span><br><span class="line">            <span class="comment">// path.resolve(&quot;./example&quot;,relativePath)  处理路径</span></span><br><span class="line">            <span class="comment">// console.log(child);</span></span><br><span class="line">            <span class="comment">// console.log(relativePath);</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">return</span> queue</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="利用ejs模板文件生成最终打包好的文件"><a href="#利用ejs模板文件生成最终打包好的文件" class="headerlink" title="利用ejs模板文件生成最终打包好的文件"></a>利用ejs模板文件生成最终打包好的文件</h2><ol>
<li>首先引入提前创建好的模板文件<code>bundle.ejs</code></li>
<li>遍历上面生成的图，遍历取得所需要的数据</li>
<li>指定出口文件<code>./dist/bundle.js</code></li>
<li>将取得的数据传给模板文件，利用ejs根据文件生成最后打包生成的文件</li>
<li>执行build方法，即可以获取打包后的文件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">build</span>(<span class="params">graph</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> template = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./bundle.ejs&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = graph.<span class="title function_">map</span>(<span class="function"><span class="params">asset</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">id</span>: asset.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">code</span>: asset.<span class="property">code</span>,</span><br><span class="line">            <span class="attr">mapping</span>: asset.<span class="property">mapping</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> code = ejs.<span class="title function_">render</span>(template, &#123;</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// console.log(data);</span></span><br><span class="line">    <span class="keyword">let</span> outputPath = <span class="string">&#x27;./dist/bundle.js&#x27;</span></span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(outputPath, code)</span><br><span class="line">    <span class="comment">// console.log(code);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他文件"><a href="#其他文件" class="headerlink" title="其他文件"></a>其他文件</h2><h3 id="bundle-ejs"><a href="#bundle-ejs" class="headerlink" title="bundle.ejs"></a>bundle.ejs</h3><ol>
<li>为了防止命名冲突，采用id代替name</li>
<li>生成图结构的时候，把文件的id作为mapping中相对路径的值存储起来<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(function (modules) &#123;  </span><br><span class="line">    function require(id) &#123;</span><br><span class="line">        const [fn, mapping] = modules[id]</span><br><span class="line">        function localRequire(filePath) &#123;</span><br><span class="line">            const id = mapping[filePath];</span><br><span class="line">            return require(id)</span><br><span class="line">        &#125;</span><br><span class="line">        const module = &#123;</span><br><span class="line">            exports: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fn(localRequire, module, module.exports)</span><br><span class="line">        return module.exports</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    require(0)</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">    &lt;% data.forEach(info =&gt; &#123; %&gt;</span><br><span class="line">        &lt;%- info[&#x27;id&#x27;] %&gt;:[function (require,module,exports) &#123;</span><br><span class="line">            &lt;%- info[&quot;code&quot;] %&gt;</span><br><span class="line">        &#125;,&lt;%- JSON.stringify(info[&quot;mapping&quot;]) %&gt;],</span><br><span class="line">    &lt;% &#125;); %&gt;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/31/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/axios%E5%B0%81%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/31/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/axios%E5%B0%81%E8%A3%85/" class="post-title-link" itemprop="url">axios封装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-31 14:32:09 / Modified: 15:58:45" itemprop="dateCreated datePublished" datetime="2022-05-31T14:32:09+08:00">2022-05-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">解决方法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h1><h2 id="axios是什么"><a href="#axios是什么" class="headerlink" title="axios是什么"></a>axios是什么</h2><ol>
<li>axios 是一个轻量的 HTTP客户端</li>
<li>特点<ul>
<li>从浏览器创建XMLHttpRequests</li>
<li>从node.js创建http请求</li>
<li>支持promise API</li>
<li>拦截请求和响应</li>
<li>转化请求数据和响应数据</li>
<li>取消请求</li>
<li>自动转化JSON数据</li>
<li>客户端支持防御XSRF</li>
</ul>
</li>
<li>简单请求</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">axios</span>(&#123;        </span><br><span class="line">  <span class="attr">url</span>:<span class="string">&#x27;xxx&#x27;</span>,    <span class="comment">// 设置请求的地址</span></span><br><span class="line">  <span class="attr">method</span>:<span class="string">&quot;GET&quot;</span>, <span class="comment">// 设置请求方法</span></span><br><span class="line">  <span class="attr">params</span>:&#123;      <span class="comment">// get请求使用params进行参数凭借,如果是post请求用data</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">page</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;  </span><br><span class="line">  <span class="comment">// res为后端返回的数据</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);   </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="为什么要进行封装"><a href="#为什么要进行封装" class="headerlink" title="为什么要进行封装"></a>为什么要进行封装</h2><ol>
<li>axios的API很友好，完全可以在项目中直接使用</li>
<li>不过随着项目规模的增大，如果没发起一次HTTP请求，就要这些比如<code>设置超时时间、设置请求头、根据项目环境判断使用哪个请求地址、错误处理等</code>重新写一遍，不仅浪费人力，而且会使代码冗余<br>比如<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">axios</span>(<span class="string">&#x27;http://localhost:3000/data&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 配置代码</span></span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="title class_">Authorization</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">transformRequest</span>: [<span class="keyword">function</span> (<span class="params">data, headers</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="comment">// 其他请求配置...</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// todo: 真正业务逻辑代码</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 错误处理代码  </span></span><br><span class="line">  <span class="keyword">if</span> (err.<span class="property">response</span>.<span class="property">status</span> === <span class="number">401</span>) &#123;</span><br><span class="line">  <span class="comment">// handle authorization error</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (err.<span class="property">response</span>.<span class="property">status</span> === <span class="number">403</span>) &#123;</span><br><span class="line">  <span class="comment">// handle server forbidden error</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他错误处理.....</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="如何封装"><a href="#如何封装" class="headerlink" title="如何封装"></a>如何封装</h2><ol>
<li>约定好请求头、状态码、请求超时时间等<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">30000</span>,  <span class="comment">// 请求 30s 超时</span></span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="attr">get</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded;charset=utf-8&#x27;</span></span><br><span class="line">          <span class="comment">// 在开发中，一般还需要单点登录或者其他功能的通用请求头，可以一并配置进来</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">post</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=utf-8&#x27;</span></span><br><span class="line">          <span class="comment">// 在开发中，一般还需要单点登录或者其他功能的通用请求头，可以一并配置进来</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>设置接口请求前缀：根据开发、测试、生产环境的不同，前缀需要加以区分<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 利用node环境变量来作判断，用来区分开发、测试、生产环境</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">  axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = <span class="string">&#x27;http://dev.xxx.com&#x27;</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = <span class="string">&#x27;http://prod.xxx.com&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在本地调试的时候，还需要在vue.config.js文件中配置devServer实现代理转发，从而实现跨域</span></span><br><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/proxyApi&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://dev.xxx.com&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;/proxyApi&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li>请求头：来实现一些具体的业务，必须携带一些参数才可以请求</li>
<li>状态码：根据接口返回的不同status，来执行不同的业务</li>
<li>请求方法：根据get、post等方法进行一个再次封装，使用起来更加方便</li>
<li>请求拦截器：根据请求的请求头设定，来决定哪些请求可以访问<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求拦截器可以在每个请求里加上token，做了统一处理后维护起来也方便</span></span><br><span class="line"><span class="comment">// 请求拦截器</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 每次发送请求之前判断是否存在token</span></span><br><span class="line">    <span class="comment">// 如果存在，则统一在http请求的header都加上token，这样后台根据token判断你的登录情况，此处token一般是用户完成登录后储存到localstorage里的</span></span><br><span class="line">    hl-&amp;&amp; (config.<span class="property">headers</span>.<span class="property">Authorization</span> = token)</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">error</span>(error)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></li>
<li>响应拦截器：根据后端返回来的状态码判定执行不同的业务<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">响应拦截器可以在接收到响应后先做一层操作，如根据状态码判断登录状态、授权</span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果返回的状态码为200，说明接口请求成功，可以正常拿到数据</span></span><br><span class="line">  <span class="comment">// 否则的话抛出错误</span></span><br><span class="line">  <span class="keyword">if</span> (response.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">data</span>.<span class="property">code</span> === <span class="number">511</span>) &#123;</span><br><span class="line">      <span class="comment">// 未授权调取授权接口</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.<span class="property">data</span>.<span class="property">code</span> === <span class="number">510</span>) &#123;</span><br><span class="line">      <span class="comment">// 未登录跳转登录页</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(response)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(response)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 我们可以在这里对异常状态作统一处理</span></span><br><span class="line">  <span class="keyword">if</span> (error.<span class="property">response</span>.<span class="property">status</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理请求失败的情况</span></span><br><span class="line">    <span class="comment">// 对不同返回码对相应处理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error.<span class="property">response</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="项目实际处理"><a href="#项目实际处理" class="headerlink" title="项目实际处理"></a>项目实际处理</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Description: 本模块用于 api调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&quot;qs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> storage <span class="keyword">from</span> <span class="string">&quot;store&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Message</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ccxd-ux&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置超时时间和baseURL</span></span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">600000</span>, <span class="comment">// 超时时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST 传参序列化，请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  	 <span class="comment">// 从localStorage中获取token</span></span><br><span class="line">    <span class="keyword">const</span> token = storage.<span class="title function_">get</span>(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      config.<span class="property">headers</span>.<span class="property">Token</span> = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">method</span> === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">      config.<span class="property">data</span> = qs.<span class="title function_">stringify</span>(config.<span class="property">data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 返回状态判断，响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> data = res.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// code由Long转为String，便于前端使用，</span></span><br><span class="line">    data.<span class="property">code</span> += <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; code, msg &#125; = data;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!code.<span class="title function_">startsWith</span>(<span class="string">&quot;200&quot;</span>)) &#123;</span><br><span class="line">      <span class="comment">// 未登录或token失效，具体code需要和后端想协商好</span></span><br><span class="line">      <span class="keyword">if</span> (code == <span class="string">&quot;4510700000&quot;</span> || code == <span class="string">&quot;3110701403&quot;</span>) &#123;</span><br><span class="line">        <span class="title class_">Message</span>(&#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;token失效，请重新登录&quot;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&quot;info&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> &#123; pathname, origin &#125; = <span class="variable language_">window</span>.<span class="property">location</span>;</span><br><span class="line">        <span class="keyword">const</span> isRuntime = storage.<span class="title function_">get</span>(<span class="string">&quot;isRuntime&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> appInfo = storage.<span class="title function_">get</span>(<span class="string">&quot;appInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isRuntime&amp;&amp;!pathname.<span class="title function_">includes</span>(<span class="string">&quot;runLogin&quot;</span>)) &#123;</span><br><span class="line">          <span class="comment">//运行态逻辑</span></span><br><span class="line">          storage.<span class="title function_">remove</span>(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="string">`<span class="subst">$&#123;origin&#125;</span>/runLogin?name=<span class="subst">$&#123;appInfo?.name&#125;</span>&amp;namespace=<span class="subst">$&#123;appInfo?.namespace&#125;</span>&amp;version=<span class="subst">$&#123;appInfo?.version&#125;</span>`</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (isRuntime&amp;&amp;pathname.<span class="title function_">includes</span>(<span class="string">&quot;runLogin&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//运行态逻辑</span></span><br><span class="line">            storage.<span class="title function_">remove</span>(<span class="string">&quot;token&quot;</span>);      </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          storage.<span class="title function_">clearAll</span>();</span><br><span class="line">          <span class="keyword">if</span> (!pathname.<span class="title function_">includes</span>(<span class="string">&quot;/login&quot;</span>) || !pathname.<span class="title function_">includes</span>(<span class="string">&quot;runLogin&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="string">`<span class="subst">$&#123;origin&#125;</span>/login`</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Message</span>(&#123;</span><br><span class="line">          <span class="attr">message</span>: msg || <span class="string">&quot;系统繁忙，请稍候再试&quot;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Message</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;系统繁忙，请稍候再试&quot;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 处理请求方法</span></span><br><span class="line"><span class="keyword">const</span> request = &#123;</span><br><span class="line">  <span class="title function_">post</span>(<span class="params">url, data, prefix = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">service</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: prefix + url,</span><br><span class="line">      data,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">url, data, prefix = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">service</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: prefix + url,</span><br><span class="line">      <span class="attr">params</span>: data,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">delete</span>(<span class="params">url, data, prefix = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">service</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;DELETE&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: prefix + url,</span><br><span class="line">      <span class="attr">params</span>: data,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">patch</span>(<span class="params">url, data, prefix = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">service</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;PATCH&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: prefix + url,</span><br><span class="line">      data,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestFile = &#123;</span><br><span class="line">  <span class="title function_">post</span>(<span class="params">url, data, prefix = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">service</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: prefix + url,</span><br><span class="line">      data,</span><br><span class="line">      <span class="attr">config</span>: &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data&quot;</span> &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> request;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%8D%81%E4%B8%87%E6%9D%A1%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/27/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%8D%81%E4%B8%87%E6%9D%A1%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">十万条数据如何处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-27 17:34:39" itemprop="dateCreated datePublished" datetime="2022-05-27T17:34:39+08:00">2022-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-31 15:58:59" itemprop="dateModified" datetime="2022-05-31T15:58:59+08:00">2022-05-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">解决方法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="渲染十万条数据，如何不让它卡顿"><a href="#渲染十万条数据，如何不让它卡顿" class="headerlink" title="渲染十万条数据，如何不让它卡顿"></a>渲染十万条数据，如何不让它卡顿</h1><h2 id="虚拟列表"><a href="#虚拟列表" class="headerlink" title="虚拟列表"></a>虚拟列表</h2><p>不渲染所有的数据，只渲染可视区域的数据，当用户滑动或者滚动时，通过监听scroll来判断是上滑还是下拉，从而更新数据</p>
<h2 id="延迟渲染"><a href="#延迟渲染" class="headerlink" title="延迟渲染"></a>延迟渲染</h2><p>也叫懒加载，最开始不渲染所有的数据，只渲染可视区域中的数据。当滚动到页面底部时，添加数据，视图渲染新增DOM</p>
<h2 id="时间分片"><a href="#时间分片" class="headerlink" title="时间分片"></a>时间分片</h2><p>分批渲染dom,使用requestAnimationFrame来让动画更加流畅</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7065218958663614500">https://juejin.cn/post/7065218958663614500</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/15/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94mixin%E6%B7%B7%E5%85%A5%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/15/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94mixin%E6%B7%B7%E5%85%A5%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">vue原理篇——mixin混入原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-15 21:13:32 / Modified: 21:13:51" itemprop="dateCreated datePublished" datetime="2022-05-15T21:13:32+08:00">2022-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mixin"><a href="#mixin" class="headerlink" title="mixin"></a>mixin</h1><ol>
<li>当我们在 Vue 里面想要复用一段业务代码逻辑时经常用到的就是混入的方法 </li>
<li>组件的方法、变量会覆盖mixin的方法、变量</li>
<li>多个组件调用同一个mixin，每个变量都是单独独立的，不会项目影响污染</li>
</ol>
<h1 id="定义全局Mixin函数"><a href="#定义全局Mixin函数" class="headerlink" title="定义全局Mixin函数"></a>定义全局Mixin函数</h1><ol>
<li>新建一个mixin.js文件，在这个文件中，把mixin定义为vue的全局方法，核心方法就是利用mergeOptions把传入的选项混入到自己的options上面</li>
<li>然后再vue的入口文件引入initMixin方法<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/global-api/mixin.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;mergeOptions&#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">initMixin</span>(<span class="params">Vue</span>)&#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property">mixin</span> = <span class="keyword">function</span> (<span class="params">mixin</span>) &#123;</span><br><span class="line">    <span class="comment">//   合并对象</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>=<span class="title function_">mergeOptions</span>(<span class="variable language_">this</span>.<span class="property">options</span>,mixin)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="mergeOptions"><a href="#mergeOptions" class="headerlink" title="mergeOptions"></a>mergeOptions</h1><ol>
<li>遍历父亲和儿子的属性进行合并，如果合并的选项有自己的合并策略，那么就是用相应的策略合并</li>
<li>生命周期的合并策略mergeHook即把全部的生命周期都各自混入成了数组的形式依次调用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/index.js</span></span><br><span class="line"><span class="comment">// 定义生命周期</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">LIFECYCLE_HOOKS</span> = [</span><br><span class="line">  <span class="string">&quot;beforeCreate&quot;</span>,</span><br><span class="line">  <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="string">&quot;beforeMount&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mounted&quot;</span>,</span><br><span class="line">  <span class="string">&quot;beforeUpdate&quot;</span>,</span><br><span class="line">  <span class="string">&quot;updated&quot;</span>,</span><br><span class="line">  <span class="string">&quot;beforeDestroy&quot;</span>,</span><br><span class="line">  <span class="string">&quot;destroyed&quot;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并策略</span></span><br><span class="line"><span class="keyword">const</span> strats = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生命周期合并策略</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeHook</span>(<span class="params">parentVal, childVal</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果有儿子</span></span><br><span class="line">  <span class="keyword">if</span> (childVal) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parentVal) &#123;</span><br><span class="line">      <span class="comment">// 合并成一个数组</span></span><br><span class="line">      <span class="keyword">return</span> parentVal.<span class="title function_">concat</span>(childVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 包装成一个数组</span></span><br><span class="line">      <span class="keyword">return</span> [childVal];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parentVal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为生命周期添加合并策略</span></span><br><span class="line"><span class="variable constant_">LIFECYCLE_HOOKS</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">  strats[hook] = mergeHook;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mixin核心方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mergeOptions</span>(<span class="params">parent, child</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line">  <span class="comment">// 遍历父亲</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    <span class="title function_">mergeFiled</span>(k);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 父亲没有 儿子有</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!parent.<span class="title function_">hasOwnProperty</span>(k)) &#123;</span><br><span class="line">      <span class="title function_">mergeFiled</span>(k);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//真正合并字段方法</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">mergeFiled</span>(<span class="params">k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (strats[k]) &#123;</span><br><span class="line">      options[k] = strats[k](parent[k], child[k]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 默认策略</span></span><br><span class="line">      options[k] = child[k] ? child[k] : parent[k];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="生命周期的调用"><a href="#生命周期的调用" class="headerlink" title="生命周期的调用"></a>生命周期的调用</h1><p>把$options 上面的生命周期依次遍历进行调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lifecycle.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">callHook</span>(<span class="params">vm, hook</span>) &#123;</span><br><span class="line">  <span class="comment">// 依次执行生命周期对应的方法</span></span><br><span class="line">  <span class="keyword">const</span> handlers = vm.<span class="property">$options</span>[hook];</span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handlers.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      handlers[i].<span class="title function_">call</span>(vm); <span class="comment">//生命周期里面的this指向当前实例</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在init初始化的时候调用mergerOptions来进行选项合并，之后再需要调用生命周期的地方运用callHook来执行用户传入的相关方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/init.js</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 这里的this代表调用_init方法的对象(实例对象)</span></span><br><span class="line">  <span class="comment">//  this.$options就是用户new Vue的时候传入的属性和全局的Vue.options合并之后的结果</span></span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(vm.<span class="property">constructor</span>.<span class="property">options</span>, options);</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&quot;beforeCreate&quot;</span>); <span class="comment">//初始化数据之前</span></span><br><span class="line">  <span class="comment">// 初始化状态</span></span><br><span class="line">  <span class="title function_">initState</span>(vm);</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&quot;created&quot;</span>); <span class="comment">//初始化数据之后</span></span><br><span class="line">  <span class="comment">// 如果有el属性 进行模板渲染</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">    vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 mountComponent 方法里面调用相关的生命周期 callHook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params">vm, el</span>) &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="comment">// 引入watcher的概念 这里注册一个渲染watcher 执行vm._update(vm._render())方法渲染视图</span></span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&quot;beforeMount&quot;</span>); <span class="comment">//初始渲染之前</span></span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">updateComponent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>());</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">    vm,</span><br><span class="line">    updateComponent,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">callHook</span>(vm, <span class="string">&quot;beforeUpdate&quot;</span>); <span class="comment">//更新之前</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  );</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&quot;mounted&quot;</span>); <span class="comment">//渲染完成之后</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/14/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/14/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">vue原理篇——异步更新原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-14 21:16:17" itemprop="dateCreated datePublished" datetime="2022-05-14T21:16:17+08:00">2022-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 09:32:38" itemprop="dateModified" datetime="2022-05-24T09:32:38+08:00">2022-05-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="异步更新原理"><a href="#异步更新原理" class="headerlink" title="异步更新原理"></a>异步更新原理</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue实例化</span></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">a</span>: <span class="number">123</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// render(h) &#123;</span></span><br><span class="line">  <span class="comment">//   return h(&#x27;div&#x27;,&#123;id:&#x27;a&#x27;&#125;,&#x27;hello&#x27;)</span></span><br><span class="line">  <span class="comment">// &#125;,</span></span><br><span class="line">  <span class="attr">template</span>: <span class="string">`&lt;div id=&quot;a&quot;&gt;hello &#123;&#123;a&#125;&#125;&lt;/div&gt;`</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当我们每一次改变数据的时候  渲染watcher都会执行一次 这个是影响性能的</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  vm.<span class="property">a</span> = <span class="number">1</span>;</span><br><span class="line">  vm.<span class="property">a</span> = <span class="number">2</span>;</span><br><span class="line">  vm.<span class="property">a</span> = <span class="number">3</span>;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>每次我们改变数据的时候都会触发相应的 watcher 进行更新,如果是渲染 watcher就意味着数据变动一次，就会重新渲染一次，这样其实是很浪费性能的，所以需要更好的方法，让数据变动完毕后统一去更新视图</p>
<h1 id="改写watcher更新方法"><a href="#改写watcher更新方法" class="headerlink" title="改写watcher更新方法"></a>改写watcher更新方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/watcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; queueWatcher &#125; <span class="keyword">from</span> <span class="string">&quot;./scheduler&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每次watcher进行更新的时候  是否可以让他们先缓存起来  之后再一起调用</span></span><br><span class="line">    <span class="comment">// 异步队列机制</span></span><br><span class="line">    <span class="title function_">queueWatcher</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 真正的触发更新</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="队列机制"><a href="#队列机制" class="headerlink" title="队列机制"></a>队列机制</h1><p>新建一个scheduler.js文件，表示和调度有关，先同步把watcher都放到队列里面取，执行完队列的事件之后再清空队列，主要用nextTick来执行watcher队列</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/scheduler.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; nextTick &#125; <span class="keyword">from</span> <span class="string">&quot;../util/next-tick&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> queue = [];</span><br><span class="line"><span class="keyword">let</span> has = &#123;&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushSchedulerQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; queue.<span class="property">length</span>; index++) &#123;</span><br><span class="line">    <span class="comment">//   调用watcher的run方法 执行真正的更新操作</span></span><br><span class="line">    queue[index].<span class="title function_">run</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行完之后清空队列</span></span><br><span class="line">  queue = [];</span><br><span class="line">  has = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现异步队列机制</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span>(<span class="params">watcher</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.<span class="property">id</span>;</span><br><span class="line">  <span class="comment">//   watcher去重</span></span><br><span class="line">  <span class="keyword">if</span> (has[id] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">//  同步代码执行 把全部的watcher都放到队列里面去</span></span><br><span class="line">    queue.<span class="title function_">push</span>(watcher);</span><br><span class="line">    has[id] = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 进行异步调用</span></span><br><span class="line">    <span class="title function_">nextTick</span>(flushSchedulerQueue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h1><ol>
<li>回调函数是一个数组，遍历数组依次执行</li>
<li>定义一个异步方法，采用降级处理的方法，依次判断，执行<code>flushCallbacks</code>方法<ul>
<li>Promise</li>
<li>MutationObserver 监听dom变化</li>
<li>setImmediate</li>
<li>setTimeout</li>
</ul>
</li>
<li>除了渲染watcher  还有用户自己手动调用的nextTick 一起被收集到数组<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/util/next-tick.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> callbacks = [];</span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">  pending = <span class="literal">false</span>; <span class="comment">//把标志还原为false</span></span><br><span class="line">  <span class="comment">// 依次执行回调</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; callbacks.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    callbacks[i]();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> timerFunc; <span class="comment">//定义异步方法  采用优雅降级</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果支持promise</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p.<span class="title function_">then</span>(flushCallbacks);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">  <span class="comment">// MutationObserver 主要是监听dom变化 也是一个异步方法</span></span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(flushCallbacks);</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(counter));</span><br><span class="line">  observer.<span class="title function_">observe</span>(textNode, &#123;</span><br><span class="line">    <span class="attr">characterData</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    counter = (counter + <span class="number">1</span>) % <span class="number">2</span>;</span><br><span class="line">    textNode.<span class="property">data</span> = <span class="title class_">String</span>(counter);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果前面都不支持 判断setImmediate</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setImmediate</span>(flushCallbacks);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 最后降级采用setTimeout</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span>(<span class="params">cb</span>) &#123;</span><br><span class="line">  <span class="comment">// 除了渲染watcher  还有用户自己手动调用的nextTick 一起被收集到数组</span></span><br><span class="line">  callbacks.<span class="title function_">push</span>(cb);</span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    <span class="comment">// 如果多次调用nextTick  只会执行一次异步 等异步队列清空之后再把标志变为false</span></span><br><span class="line">    pending = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">timerFunc</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="nextTick-挂载原型"><a href="#nextTick-挂载原型" class="headerlink" title="$nextTick 挂载原型"></a>$nextTick 挂载原型</h1><p>在vue原型上挂载一个$nextTick方法，使用户可以手动调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/render.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; nextTick &#125; <span class="keyword">from</span> <span class="string">&quot;./util/next-tick&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span>(<span class="params">Vue</span>) &#123;</span><br><span class="line">  <span class="comment">// 挂载在原型的nextTick方法 可供用户手动调用</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = nextTick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/12/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/vue/vue%E5%8E%9F%E7%90%86/vue%E5%8E%9F%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">vue原理篇——渲染更新原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-12 22:56:21" itemprop="dateCreated datePublished" datetime="2022-05-12T22:56:21+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 15:22:41" itemprop="dateModified" datetime="2022-05-24T15:22:41+08:00">2022-05-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="渲染更新原理"><a href="#渲染更新原理" class="headerlink" title="渲染更新原理"></a>渲染更新原理</h1><p>由初次渲染原理可知，实例挂载之后，会调用<code>vm._update(vm._render())</code>来更新视图，<code>_update</code>方法内部调用了patch方法，但是不可能每次数据变化都要求用户自己去调用渲染方法更新视图，所以需要一个机制再数据变动的时候自动更新</p>
<h1 id="watcher"><a href="#watcher" class="headerlink" title="watcher"></a>watcher</h1><p>首先，我们需要使用到<code>观察者模式</code>来订阅数据的变动，所以新建一个watcher作为观察者，用它来订阅数据的变化，当数据变动之后，通知他去执行某些方法</p>
<h2 id="定义watcher"><a href="#定义watcher" class="headerlink" title="定义watcher"></a>定义watcher</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/watcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量id  每次new Watcher都会自增</span></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">vm, exprOrFn, cb, options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">exprOrFn</span> = exprOrFn;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb; <span class="comment">//回调函数 比如在watcher更新之前可以执行beforeUpdate方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options; <span class="comment">//额外的选项 true代表渲染watcher</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id++; <span class="comment">// watcher的唯一标识</span></span><br><span class="line">    <span class="comment">// 如果表达式是一个函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> exprOrFn === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = exprOrFn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实例化就会默认调用get方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，在组件挂载，即<code>mountComponent</code>中，要定义一个渲染watcher主要功能就是执行核心渲染页面的方法</p>
<h1 id="dep"><a href="#dep" class="headerlink" title="dep"></a>dep</h1><ol>
<li>随着watcher的增多，需要一个容器来管理，所以产生了dep</li>
<li>dep也是一个构造函数，可以把它理解为观察者模式里面的被观察者</li>
<li>在subs里面收集watcher，当数据变动的时候通知吱声subs所有的watcher更新</li>
<li>dep.target是一个全局watcher指向，初始状态为null</li>
</ol>
<h1 id="对象的依赖收集"><a href="#对象的依赖收集" class="headerlink" title="对象的依赖收集"></a>对象的依赖收集</h1><p>对象的依赖收集借助于响应式原理，即数据在被访问的时候，把我们定义好的渲染watcher放到dep的subs数组里面，同时把deo实例对象也放到渲染watcher里面取，数据更新的时候就可以通知dep的subs存储的watcher更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.defineProperty数据劫持核心 兼容性在ie9以及以上</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive</span>(<span class="params">data, key, value</span>) &#123;</span><br><span class="line">  <span class="title function_">observe</span>(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>(); <span class="comment">// 为每个属性实例化一个Dep</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 页面取值的时候 可以把watcher收集到dep里面--依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果有watcher dep就会保存watcher 同时watcher也会保存dep</span></span><br><span class="line">        dep.<span class="title function_">depend</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newValue === value) <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">// 如果赋值的新值也是一个对象  需要观测</span></span><br><span class="line">      <span class="title function_">observe</span>(newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">      dep.<span class="title function_">notify</span>(); <span class="comment">// 通知渲染watcher去更新--派发更新</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="完善watcher"><a href="#完善watcher" class="headerlink" title="完善watcher"></a>完善watcher</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/watcher.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; pushTarget, popTarget &#125; <span class="keyword">from</span> <span class="string">&quot;./dep&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量id  每次new Watcher都会自增</span></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">vm, exprOrFn, cb, options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">exprOrFn</span> = exprOrFn;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb; <span class="comment">//回调函数 比如在watcher更新之前可以执行beforeUpdate方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options; <span class="comment">//额外的选项 true代表渲染watcher</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id++; <span class="comment">// watcher的唯一标识</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span> = []; <span class="comment">//存放dep的容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depsId</span> = <span class="keyword">new</span> <span class="title class_">Set</span>(); <span class="comment">//用来去重dep</span></span><br><span class="line">    <span class="comment">// 如果表达式是一个函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> exprOrFn === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = exprOrFn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实例化就会默认调用get方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">pushTarget</span>(<span class="variable language_">this</span>); <span class="comment">// 在调用方法之前先把当前watcher实例推到全局Dep.target上</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getter</span>(); <span class="comment">//如果watcher是渲染watcher 那么就相当于执行  vm._update(vm._render()) 这个方法在render函数执行的时候会取值 从而实现依赖收集</span></span><br><span class="line">    <span class="title function_">popTarget</span>(); <span class="comment">// 在调用方法之后把当前watcher实例从全局Dep.target移除</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//   把dep放到deps里面 同时保证同一个dep只被保存到watcher一次  同样的  同一个watcher也只会保存在dep一次</span></span><br><span class="line">  <span class="title function_">addDep</span>(<span class="params">dep</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> id = dep.<span class="property">id</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depsId</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">depsId</span>.<span class="title function_">add</span>(id);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">      <span class="comment">//   直接调用dep的addSub方法  把自己--watcher实例添加到dep的subs容器里面</span></span><br><span class="line">      dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//   这里简单的就执行以下get方法  之后涉及到计算属性就不一样了</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="完善dep"><a href="#完善dep" class="headerlink" title="完善dep"></a>完善dep</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/dep.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dep和watcher是多对多的关系</span></span><br><span class="line"><span class="comment">// 每个属性都有自己的dep</span></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span>; <span class="comment">//dep实例的唯一标识</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id++;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = []; <span class="comment">// 这个是存放watcher的容器</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">depend</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//   如果当前存在watcher</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">      <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>); <span class="comment">// 把自身-dep实例存放在watcher里面</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//   依次执行subs里面的watcher更新方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">watcher</span>) =&gt;</span> watcher.<span class="title function_">update</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">addSub</span>(<span class="params">watcher</span>) &#123;</span><br><span class="line">    <span class="comment">//   把watcher加入到自身的subs容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(watcher);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 默认Dep.target为null</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 栈结构用来存watcher</span></span><br><span class="line"><span class="keyword">const</span> targetStack = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pushTarget</span>(<span class="params">watcher</span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">push</span>(watcher);</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = watcher; <span class="comment">// Dep.target指向当前watcher</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">popTarget</span>(<span class="params"></span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">pop</span>(); <span class="comment">// 当前watcher出栈 拿到上一个watcher</span></span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = targetStack[targetStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="数组的依赖收集"><a href="#数组的依赖收集" class="headerlink" title="数组的依赖收集"></a>数组的依赖收集</h1><ol>
<li>如果对象属性的值是一个数组，那么执行<code>childOb.dep.depend()</code>收集数组的依赖，如果数组里面还包含数组，需要递归遍历收集</li>
<li>因为只有访问数据触发了get才会去收集依赖，一开始只是递归对数据进行响应式处理无法收集依赖</li>
<li>depend方法中，如果当前存在watcher，就会触发<code>Dep.target.addDep(this)</code>，把自身dep放到watcher里面，addSub中执行<code>this.subs.push(watcher)</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/observer/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.defineProperty数据劫持核心 兼容性在ie9以及以上</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive</span>(<span class="params">data, key, value</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> childOb = <span class="title function_">observe</span>(value); <span class="comment">// childOb就是Observer实例</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>(); <span class="comment">// 为每个属性实例化一个Dep</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 页面取值的时候 可以把watcher收集到dep里面--依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果有watcher dep就会保存watcher 同时watcher也会保存dep</span></span><br><span class="line">        dep.<span class="title function_">depend</span>();</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          <span class="comment">// 这里表示 属性的值依然是一个对象 包含数组和对象 childOb指代的就是Observer实例对象  里面的dep进行依赖收集</span></span><br><span class="line">          <span class="comment">// 比如&#123;a:[1,2,3]&#125; 属性a对应的值是一个数组 观测数组的返回值就是对应数组的Observer实例对象</span></span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>();</span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">            <span class="comment">// 如果数据结构类似 &#123;a:[1,2,[3,4,[5,6]]]&#125; 这种数组多层嵌套  数组包含数组的情况  那么我们访问a的时候 只是对第一层的数组进行了依赖收集 里面的数组因为没访问到  所以五大收集依赖  但是如果我们改变了a里面的第二层数组的值  是需要更新页面的  所以需要对数组递归进行依赖收集</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">              <span class="comment">// 如果内部还是数组</span></span><br><span class="line">              <span class="title function_">dependArray</span>(value); <span class="comment">// 不停的进行依赖收集</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newValue === value) <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">// 如果赋值的新值也是一个对象  需要观测</span></span><br><span class="line">      <span class="title function_">observe</span>(newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">      dep.<span class="title function_">notify</span>(); <span class="comment">// 通知渲染watcher去更新--派发更新</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 递归收集数组依赖</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dependArray</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> e, i = <span class="number">0</span>, l = value.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    e = value[i];</span><br><span class="line">    <span class="comment">// e.__ob__代表e已经被响应式观测了 但是没有收集依赖 所以把他们收集到自己的Observer实例的dep里面</span></span><br><span class="line">    e &amp;&amp; e.<span class="property">__ob__</span> &amp;&amp; e.<span class="property">__ob__</span>.<span class="property">dep</span>.<span class="title function_">depend</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(e)) &#123;</span><br><span class="line">      <span class="comment">// 如果数组里面还有数组  就递归去收集依赖</span></span><br><span class="line">      <span class="title function_">dependArray</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="数组的派发更新"><a href="#数组的派发更新" class="headerlink" title="数组的派发更新"></a>数组的派发更新</h1><ol>
<li>数组更新主要是修改了Array原型上的方法</li>
<li>会首先执行原型方法，之后判断数据有没有__ob__属性，来判断数据是否已经被响应式观察过了</li>
<li>执行notify方法，触发sub里面watcher的更新方法<code>watcher.update()</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/ src/observer/array.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">methodsToPatch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">method</span>) =&gt;</span> &#123;</span><br><span class="line">  arrayMethods[method] = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="comment">//   这里保留原型方法的执行结果</span></span><br><span class="line">    <span class="keyword">const</span> result = arrayProto[method].<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    <span class="comment">// 这句话是关键</span></span><br><span class="line">    <span class="comment">// this代表的就是数据本身 比如数据是&#123;a:[1,2,3]&#125; 那么我们使用a.push(4)  this就是a  ob就是a.__ob__ 这个属性代表的是该数据已经被响应式观察过了 __ob__对象指的就是Observer实例</span></span><br><span class="line">    <span class="keyword">const</span> ob = <span class="variable language_">this</span>.<span class="property">__ob__</span>;</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;push&quot;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;unshift&quot;</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;splice&quot;</span>:</span><br><span class="line">        inserted = args.<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.<span class="title function_">observeArray</span>(inserted); <span class="comment">// 对新增的每一项进行观测</span></span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>(); <span class="comment">//数组派发更新 ob指的就是数组对应的Observer实例 我们在get的时候判断如果属性的值还是对象那么就在Observer实例的dep收集依赖 所以这里是一一对应的  可以直接更新</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
